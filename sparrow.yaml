image:
  - melezhik/sparrow:debian

secrets:
  - FEZ_TOKEN
tasks:
  - name: fez-upload
    default: true
    language: Raku
    init: |
      run_task "test";
      if config()<tasks><git-commit><state><comment> ~~ /'ci: fez upload'/ {
        run_task "upload"
      }
    subtasks:
    - 
      name: test
      language: Bash
      code: |
        set -e
        cd source
        zef test .
    -
      name: upload
      language: Bash
      code: |
        set -e
        cat << HERE > ~/.fez-config.json
          {"groups":[],"un":"melezhik","key":"${FEZ_TOKEN}"}
        HERE
        cd source/
        zef install --/test fez
        # fez checkbuild
        tom --clean
        # sudo cat /etc/resolv.conf 
        # curl --trace-ascii - api.zef.pm
        fez upload < /dev/null 
    depends:
      -
        name: git-commit
  - name: git-commit
    plugin: git-commit-data
    config:
      dir: source 
